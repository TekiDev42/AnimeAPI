<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>AnimeAPI</title>
</head>
<body>

    <div id="response" style="display:flex;flex-direction:column;"></div>

    <form id="form_add_user" method="POST" style="display: flex;flex-direction: column;max-width: 640px;">
        <h2>Create user</h2>

        <label for="username_add">username</label>
        <input id="username_add" type="text" name="username">

        <label for="password_add">password</label>
        <input id="password_add" type="password" name="password">

        <label for="useremail_add">email</label>
        <input id="useremail_add" type="email" name="useremail">

        <button type="submit">Valider</button>
    </form>


    <form id="form_get_token" method="POST" style="display: flex;flex-direction: column;max-width: 640px;">
        <h2>GET TOKEN</h2>

        <label for="username">username</label>
        <input id="username" type="text" name="username">

        <label for="password">password</label>
        <input id="password" type="password" name="password">

        <button type="submit">Valider</button>
    </form>


    <p><button id="get-data">Get data</button></p>

<script defer async>
    // jwt_decode

    const form_user = document.querySelector('#form_add_user');
    form_user.addEventListener('submit', async (evt) => {
        evt.preventDefault()
        const data = new FormData(form_user);

        const query = await fetch("http://127.0.0.1:8000/signin/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({username: data.get('username'), password: data.get('password'),useremail: data.get('useremail')})
        });

        const response = await query.json();
        console.log(response);
    });

    const form = document.querySelector('#form_get_token');
    form.addEventListener('submit', async (evt) => {
        evt.preventDefault()
        const data = new FormData(form);

        const query = await fetch("http://127.0.0.1:8000/token/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({username: data.get('username'), password: data.get('password')})
        })

        const response = await query.json();
        localStorage.setItem("authTokens", JSON.stringify(response));
    });

    const button = document.querySelector('#get-data');
    button.addEventListener('click', async (evt) => {
        evt.preventDefault()

        const token = JSON.parse(localStorage.getItem('authTokens'));

        const query = await fetch(`http://127.0.0.1:8000/animes/`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token.access}`
            }
        })

        const response = await query.json();
        console.log(response)
    })
</script>

</body>
</html>